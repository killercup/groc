<!DOCTYPE html><html lang="en"><head><title>scripts/publish-git-pages</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="scripts/publish-git-pages"><meta name="groc-project-path" content="scripts/publish-git-pages.sh"><meta name="groc-github-url" content="https://github.com/nevir/groc"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/nevir/groc/blob/master/scripts/publish-git-pages.sh">scripts/publish-git-pages.sh</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="keyword">set</span> <span class="operator">-e</span> <span class="comment"># Stop on the first failure that occurs</span>

DOCS_PATH=.git/groc-tmp
TARGET_BRANCH=gh-pages
[[ <span class="variable">$1</span> ]] &amp;&amp; TARGET_REMOTE=<span class="variable">$1</span> || TARGET_REMOTE=origin</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Git spits out status information on $stderr, and we don&#39;t want to relay that as an error to the
user.  So we wrap git and do error handling ourselves...</p></div></div><div class="code"><div class="wrapper"><span class="function"><span class="title">exec_git</span></span>() {
  args=<span class="string">''</span>
  <span class="keyword">for</span> (( i = <span class="number">1</span>; i &lt;= <span class="variable">$#</span>; i++ )); <span class="keyword">do</span>
    <span class="built_in">eval</span> arg=\$<span class="variable">$i</span>
    <span class="keyword">if</span> [[ <span class="variable">$arg</span> == *\ * ]]; <span class="keyword">then</span>
      <span class="comment">#  We assume that double quotes will not be used as part of argument values.</span>
      args=<span class="string">"<span class="variable">$args</span> \"<span class="variable">$arg</span>\""</span>
    <span class="keyword">else</span>
      args=<span class="string">"<span class="variable">$args</span> <span class="variable">$arg</span>"</span>
    <span class="keyword">fi</span>
  <span class="keyword">done</span>

  <span class="keyword">set</span> +e
  <span class="comment">#  Even though we wrap the arguments in quotes, bash is splitting on whitespace within.  Why?</span>
  result=`<span class="built_in">eval</span> git <span class="variable">$args</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span>`
  status=$?
  <span class="keyword">set</span> <span class="operator">-e</span>

  <span class="keyword">if</span> [[ <span class="variable">$status</span> <span class="operator">-ne</span> <span class="number">0</span> ]]; <span class="keyword">then</span>
    <span class="built_in">echo</span> <span class="string">"<span class="variable">$result</span>"</span> &gt;&amp;<span class="number">2</span>
    <span class="keyword">exit</span> <span class="variable">$status</span>
  <span class="keyword">fi</span>

  <span class="built_in">echo</span> <span class="string">"<span class="variable">$result</span>"</span>
  <span class="keyword">return</span> <span class="number">0</span>
}

<span class="keyword">if</span> [[ `git status <span class="operator">-s</span>` != <span class="string">""</span> ]]; <span class="keyword">then</span>
  <span class="built_in">echo</span> <span class="string">"Please commit or stash your changes before publishing documentation to github!"</span> &gt;&amp;<span class="number">2</span>
  <span class="keyword">exit</span> <span class="number">1</span>
<span class="keyword">fi</span>

CURRENT_BRANCH=`git branch <span class="number">2</span>&gt;/dev/null| sed -n <span class="string">'/^\*/s/^\* //p'</span>`
CURRENT_COMMIT=`git rev-parse HEAD`</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Preserve the project&#39;s .gitignore so that we don&#39;t check in or otherwise screw up hidden files</p></div></div><div class="code"><div class="wrapper"><span class="keyword">if</span> [[ <span class="operator">-e</span> .gitignore ]]; <span class="keyword">then</span>
  cp .gitignore <span class="variable">$DOCS_PATH</span>/
<span class="keyword">fi</span>

<span class="keyword">if</span> [[ `git branch --no-color | grep <span class="string">" <span class="variable">$TARGET_BRANCH</span>"</span>` == <span class="string">""</span> ]]; <span class="keyword">then</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Do a fetch from the target remote to see if it was created remotely</p></div></div><div class="code"><div class="wrapper">  <span class="keyword">exec</span>_git fetch <span class="variable">$TARGET_REMOTE</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Does it exist remotely?</p></div></div><div class="code"><div class="wrapper">  <span class="keyword">if</span> [[ `git branch <span class="operator">-a</span> --no-color | grep <span class="string">" remotes/<span class="variable">$TARGET_REMOTE</span>/<span class="variable">$TARGET_BRANCH</span>"</span>` == <span class="string">""</span> ]]; <span class="keyword">then</span>
    <span class="built_in">echo</span> <span class="string">"No '<span class="variable">$TARGET_BRANCH</span>' branch exists.  Creating one"</span>
    <span class="keyword">exec</span>_git symbolic-ref HEAD refs/heads/<span class="variable">$TARGET_BRANCH</span>
    rm .git/index</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Preserve ignored files, but make sure they&#39;re actually ignored!</p></div></div><div class="code"><div class="wrapper">    <span class="keyword">if</span> [[ <span class="operator">-e</span> <span class="variable">$DOCS_PATH</span>/.gitignore ]]; <span class="keyword">then</span>
      cp <span class="variable">$DOCS_PATH</span>/.gitignore .gitignore
      <span class="keyword">exec</span>_git add .gitignore
    <span class="keyword">fi</span>

    <span class="keyword">exec</span>_git clean -fdq
  <span class="keyword">else</span>
    TARGET_REMOTE=origin
    <span class="built_in">echo</span> <span class="string">"No local branch '<span class="variable">$TARGET_BRANCH</span>', checking out '<span class="variable">$TARGET_REMOTE</span>/<span class="variable">$TARGET_BRANCH</span>' and tracking that"</span>
    <span class="keyword">exec</span>_git checkout -b <span class="variable">$TARGET_BRANCH</span> <span class="variable">$TARGET_REMOTE</span>/<span class="variable">$TARGET_BRANCH</span>
  <span class="keyword">fi</span>

<span class="keyword">else</span>
  <span class="keyword">exec</span>_git checkout <span class="variable">$TARGET_BRANCH</span>
<span class="keyword">fi</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We want to keep in complete sync (deleting old docs, or cruft from previous documentation output)</p></div></div><div class="code"><div class="wrapper"><span class="keyword">exec</span>_git ls-files | xargs rm</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The previous solution below fails to copy .dot-files, therefore we utilize
<code>find</code>, which in turn also made the <code>if</code>-statement obsolete.</p>
<blockquote>
<pre><code>cp -Rf $DOCS_PATH/* .
if [[ -e $DOCS_PATH/.gitignore ]]; then
  cp $DOCS_PATH/.gitignore .gitignore
fi</code></pre>
</blockquote>
<p>Alternative solution using <code>tar</code></p>
<blockquote>
<pre><code>( cd $DOCS_PATH ; tar --excude .git cf - . ) | tar xkpvvf -</code></pre>
</blockquote></div></div><div class="code"><div class="wrapper">find <span class="variable">$DOCS_PATH</span> -maxdepth <span class="number">1</span> -not -path <span class="variable">$DOCS_PATH</span> -and -not -path <span class="variable">$DOCS_PATH</span>/.git -exec cp -Rf <span class="string">"{}"</span> . \;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Do nothing unless we actually have changes</p></div></div><div class="code"><div class="wrapper"><span class="keyword">if</span> [[ `git status <span class="operator">-s</span>` != <span class="string">""</span> ]]; <span class="keyword">then</span>
  <span class="keyword">exec</span>_git add -A
  <span class="keyword">exec</span>_git commit -m <span class="string">"Generated documentation for <span class="variable">$CURRENT_COMMIT</span>"</span>
  <span class="keyword">exec</span>_git push <span class="variable">$TARGET_REMOTE</span> <span class="variable">$TARGET_BRANCH</span>
<span class="keyword">fi</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Clean up after ourselves</p></div></div><div class="code"><div class="wrapper">rm -rf <span class="variable">$DOCS_PATH</span>

<span class="keyword">exec</span>_git checkout <span class="variable">$CURRENT_BRANCH</span></div></div></div></div></body></html>
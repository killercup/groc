<!DOCTYPE html><html lang="en"><head><title>scripts/publish-git-pages</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="scripts/publish-git-pages"><meta name="groc-project-path" content="scripts/publish-git-pages.sh"><meta name="groc-github-url" content="https://github.com/nevir/groc"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/nevir/groc/blob/master/scripts/publish-git-pages.sh">scripts/publish-git-pages.sh</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">set</span> <span class="hljs-operator">-e</span> <span class="hljs-comment"># Stop on the first failure that occurs</span>

DOCS_PATH=.git/groc-tmp
TARGET_BRANCH=gh-pages
[[ <span class="hljs-variable">$1</span> ]] &amp;&amp; TARGET_REMOTE=<span class="hljs-variable">$1</span> || TARGET_REMOTE=origin</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Git spits out status information on $stderr, and we don't want to relay that as an error to the
user.  So we wrap git and do error handling ourselves...</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-title">exec_git</span></span>() {
  args=<span class="hljs-string">''</span>
  <span class="hljs-keyword">for</span> (( i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-variable">$#</span>; i++ )); <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">eval</span> arg=\$<span class="hljs-variable">$i</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$arg</span> == *\ * ]]; <span class="hljs-keyword">then</span>
      <span class="hljs-comment"># We assume that double quotes will not be used as part of argument values.</span>
      args=<span class="hljs-string">"<span class="hljs-variable">$args</span> \"<span class="hljs-variable">$arg</span>\""</span>
    <span class="hljs-keyword">else</span>
      args=<span class="hljs-string">"<span class="hljs-variable">$args</span> <span class="hljs-variable">$arg</span>"</span>
    <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">done</span>

  <span class="hljs-keyword">set</span> +e
  <span class="hljs-comment"># Even though we wrap the arguments in quotes, bash is splitting on whitespace within.  Why?</span>
  result=`<span class="hljs-built_in">eval</span> git <span class="hljs-variable">$args</span> <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span>`
  status=$?
  <span class="hljs-keyword">set</span> <span class="hljs-operator">-e</span>

  <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$status</span> <span class="hljs-operator">-ne</span> <span class="hljs-number">0</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$result</span>"</span> &gt;&amp;<span class="hljs-number">2</span>
    <span class="hljs-keyword">exit</span> <span class="hljs-variable">$status</span>
  <span class="hljs-keyword">fi</span>

  <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$result</span>"</span>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
}

<span class="hljs-keyword">if</span> [[ `git status <span class="hljs-operator">-s</span>` != <span class="hljs-string">""</span> ]]; <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"Please commit or stash your changes before publishing documentation to github!"</span> &gt;&amp;<span class="hljs-number">2</span>
  <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">fi</span>

CURRENT_BRANCH=`git branch <span class="hljs-number">2</span>&gt;/dev/null| sed -n <span class="hljs-string">'/^\*/s/^\* //p'</span>`
CURRENT_COMMIT=`git rev-parse HEAD`</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Preserve the project's .gitignore so that we don't check in or otherwise screw up hidden files</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">if</span> [[ <span class="hljs-operator">-e</span> .gitignore ]]; <span class="hljs-keyword">then</span>
  cp .gitignore <span class="hljs-variable">$DOCS_PATH</span>/
<span class="hljs-keyword">fi</span>

<span class="hljs-keyword">if</span> [[ `git branch --no-color | grep <span class="hljs-string">" <span class="hljs-variable">$TARGET_BRANCH</span>"</span>` == <span class="hljs-string">""</span> ]]; <span class="hljs-keyword">then</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Do a fetch from the target remote to see if it was created remotely</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">exec</span>_git fetch <span class="hljs-variable">$TARGET_REMOTE</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Does it exist remotely?</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> [[ `git branch <span class="hljs-operator">-a</span> --no-color | grep <span class="hljs-string">" remotes/<span class="hljs-variable">$TARGET_REMOTE</span>/<span class="hljs-variable">$TARGET_BRANCH</span>"</span>` == <span class="hljs-string">""</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"No '<span class="hljs-variable">$TARGET_BRANCH</span>' branch exists.  Creating one"</span>
    <span class="hljs-keyword">exec</span>_git symbolic-ref HEAD refs/heads/<span class="hljs-variable">$TARGET_BRANCH</span>
    rm .git/index</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Preserve ignored files, but make sure they're actually ignored!</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> [[ <span class="hljs-operator">-e</span> <span class="hljs-variable">$DOCS_PATH</span>/.gitignore ]]; <span class="hljs-keyword">then</span>
      cp <span class="hljs-variable">$DOCS_PATH</span>/.gitignore .gitignore
      <span class="hljs-keyword">exec</span>_git add .gitignore
    <span class="hljs-keyword">fi</span>

    <span class="hljs-keyword">exec</span>_git clean -fdq
  <span class="hljs-keyword">else</span>
    TARGET_REMOTE=origin
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"No local branch '<span class="hljs-variable">$TARGET_BRANCH</span>', checking out '<span class="hljs-variable">$TARGET_REMOTE</span>/<span class="hljs-variable">$TARGET_BRANCH</span>' and tracking that"</span>
    <span class="hljs-keyword">exec</span>_git checkout -b <span class="hljs-variable">$TARGET_BRANCH</span> <span class="hljs-variable">$TARGET_REMOTE</span>/<span class="hljs-variable">$TARGET_BRANCH</span>
  <span class="hljs-keyword">fi</span>

<span class="hljs-keyword">else</span>
  <span class="hljs-keyword">exec</span>_git checkout <span class="hljs-variable">$TARGET_BRANCH</span>
<span class="hljs-keyword">fi</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We want to keep in complete sync (deleting old docs, or cruft from previous documentation output)</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">exec</span>_git ls-files | xargs rm</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The previous solution below fails to copy .dot-files, therefore we utilize
<code>find</code>, which in turn also made the <code>if</code>-statement obsolete.</p>

<blockquote>
<pre><code>cp -Rf $DOCS_PATH/* .
if [[ -e $DOCS_PATH/.gitignore ]]; then
  cp $DOCS_PATH/.gitignore .gitignore
fi
</code></pre>
</blockquote>

<p>Alternative solution using <code>tar</code></p>

<blockquote>
<pre><code>( cd $DOCS_PATH ; tar --excude .git cf - . ) | tar xkpvvf -
</code></pre>
</blockquote></div></div><div class="code"><div class="wrapper">find <span class="hljs-variable">$DOCS_PATH</span> -maxdepth <span class="hljs-number">1</span> -not -path <span class="hljs-variable">$DOCS_PATH</span> -and -not -path <span class="hljs-variable">$DOCS_PATH</span>/.git -exec cp -Rf <span class="hljs-string">"{}"</span> . \;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Do nothing unless we actually have changes</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">if</span> [[ `git status <span class="hljs-operator">-s</span>` != <span class="hljs-string">""</span> ]]; <span class="hljs-keyword">then</span>
  <span class="hljs-keyword">exec</span>_git add -A
  <span class="hljs-keyword">exec</span>_git commit -m <span class="hljs-string">"Generated documentation for <span class="hljs-variable">$CURRENT_COMMIT</span>"</span>
  <span class="hljs-keyword">exec</span>_git push <span class="hljs-variable">$TARGET_REMOTE</span> <span class="hljs-variable">$TARGET_BRANCH</span>
<span class="hljs-keyword">fi</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Clean up after ourselves</p></div></div><div class="code"><div class="wrapper">rm -rf <span class="hljs-variable">$DOCS_PATH</span>

<span class="hljs-keyword">exec</span>_git checkout <span class="hljs-variable">$CURRENT_BRANCH</span></div></div></div></div></body></html>